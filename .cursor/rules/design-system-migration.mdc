---
description: Design System Migration Guide - ONLY apply when user asks to inject, migrate, or set up a Design System
globs:
  - "**/design-systems/**"
  - "**/design-system.config.json"
  - "**/colors.js"
  - "**/globals.css"
---

# Design System Migration Guide

This rule applies ONLY when the user explicitly asks to inject, migrate, import, or set up a Design System (DS).

**DO NOT apply this rule** when generating normal UI components, pages, or features.

## When to Apply

Apply this rule when the user mentions:
- "inject design system" / "migrate design system" / "apply [Name] Design System"
- "set up [Name] tokens" / "add Carbon" / "add Polaris" / "add Material"
- Working with `./design-systems/` folder

## CRITICAL: Understand the Dual Color System

This repo has TWO color systems that BOTH must be updated:

| System | File | Generates Classes | Used By |
|--------|------|-------------------|---------|
| **Numeric palette** | `data/config/colors.js` | `bg-primary-100` to `bg-primary-900`, `bg-secondary-100` to `bg-secondary-900` | Components using explicit shades (Button, Badge, CTA) |
| **Shadcn semantic vars** | `css/globals.css` | `bg-background`, `text-foreground`, `bg-card`, `bg-muted`, `bg-destructive`, `text-primary-foreground` | Components using semantic tokens (Dialog, Card, Input, Alert) |

**Both systems feed into `tailwind.config.js`** which merges them. If you only update one, components will be inconsistent.

## Standardized DS Input Format

If a `design-system.config.json` exists in the DS folder, use it directly. This file contains ALL tokens pre-extracted.

**Expected location:** `./design-systems/[NAME]/design-system.config.json`

**Schema:**

```json
{
  "name": "Design System Name",
  "version": "1.0",
  "colors": {
    "primary": {
      "lighter": "#hex", "light": "#hex", "main": "#hex", "dark": "#hex", "darker": "#hex"
    },
    "secondary": {
      "lighter": "#hex", "light": "#hex", "main": "#hex", "dark": "#hex", "darker": "#hex"
    }
  },
  "cssVariables": {
    "light": {
      "background": "H S% L%",
      "foreground": "H S% L%",
      "card": "H S% L%",
      "card-foreground": "H S% L%",
      "popover": "H S% L%",
      "popover-foreground": "H S% L%",
      "primary-foreground": "H S% L%",
      "secondary": "H S% L%",
      "secondary-foreground": "H S% L%",
      "muted": "H S% L%",
      "muted-foreground": "H S% L%",
      "accent": "H S% L%",
      "accent-foreground": "H S% L%",
      "destructive": "H S% L%",
      "destructive-foreground": "H S% L%",
      "border": "H S% L%",
      "input": "H S% L%",
      "radius": "0.5rem"
    },
    "dark": {
      "...same keys with dark mode values..."
    }
  },
  "typography": {
    "fontFamily": "Font Name",
    "googleFontsImport": "Font_Name",
    "displayFont": "Font Name",
    "monoFont": "Mono Font Name",
    "weights": [300, 400, 500, 600, 700]
  },
  "borderRadius": {
    "none": "0px",
    "sm": "2px",
    "DEFAULT": "4px",
    "md": "6px",
    "lg": "8px",
    "xl": "12px",
    "full": "9999px"
  },
  "shadows": {
    "sm": "shadow value",
    "DEFAULT": "shadow value",
    "md": "shadow value",
    "lg": "shadow value",
    "xl": "shadow value"
  },
  "spacing": {
    "baseUnit": "8px",
    "scale": { "0.5": "4px", "1": "8px", "2": "16px", "3": "24px", "4": "32px" }
  }
}
```

If no config.json exists, extract tokens manually from the DS source files (see Phase 1).

## Migration Workflow

### Phase 0: Git Safety

**ALWAYS create a branch before injection:**

```bash
git checkout -b ds/[NAME]-injection
```

This ensures the main branch stays clean. If injection fails, you can discard the branch.

### Phase 1: Exploration & Token Extraction

#### If `design-system.config.json` exists:
Read it and proceed to Phase 2.

#### If only source code exists:

1. **List the DS folder:**
   ```bash
   ls -la ./design-systems/[NAME]/
   ```

2. **Find token files** (check these locations in order):
   - `tokens.json`, `tokens.md`, `theme.json`
   - `packages/*/tokens/`, `packages/*/styles/`
   - `src/tokens/`, `src/theme/`, `src/styles/`
   - CSS/SCSS files with variable definitions

3. **Extract ALL tokens into these categories:**

   **Colors (FULL palette):**
   - Primary: 5 levels (lighter, light, main, dark, darker)
   - Secondary: 5 levels
   - Semantic: error/destructive, warning, success, info
   - Neutrals: gray scale (at least 50, 100, 200, 300, 400, 500, 600, 700, 800, 900)
   - Surface: background, card, elevated, overlay
   - Text: primary, secondary, disabled

   **Typography:**
   - Font families (body, display, mono)
   - Font sizes scale
   - Font weights used
   - Line heights

   **Spacing:**
   - Base unit (typically 4px or 8px)
   - Complete scale

   **Border Radius:**
   - All levels from none to full

   **Shadows/Elevation:**
   - All elevation levels

### Phase 2: Update Configuration Files (Config-First Strategy)

**IMPORTANT: Update config files FIRST. This automatically changes ~80% of the visual appearance without touching any component files.**

#### 2.1 Colors (`data/config/colors.js`)

Update the primary and secondary palettes. This automatically updates all `bg-primary-*` and `bg-secondary-*` classes across all components.

```javascript
const colors = {
  primary: {
    lighter: '#DS_PRIMARY_LIGHTER',
    light: '#DS_PRIMARY_LIGHT',
    main: '#DS_PRIMARY_MAIN',
    dark: '#DS_PRIMARY_DARK',
    darker: '#DS_PRIMARY_DARKER',
  },
  secondary: {
    lighter: '#DS_SECONDARY_LIGHTER',
    light: '#DS_SECONDARY_LIGHT',
    main: '#DS_SECONDARY_MAIN',
    dark: '#DS_SECONDARY_DARK',
    darker: '#DS_SECONDARY_DARKER',
  },
};
module.exports = { colors };
```

#### 2.2 CSS Variables (`css/globals.css`)

Update ALL Shadcn semantic variables in BOTH `:root` (light) and `.dark` sections. Values are in HSL format WITHOUT `hsl()` wrapper (just `H S% L%`).

**Light mode (`:root`):**
```css
--background: H S% L%;
--foreground: H S% L%;
--card: H S% L%;
--card-foreground: H S% L%;
--popover: H S% L%;
--popover-foreground: H S% L%;
--primary-foreground: H S% L%;
--secondary: H S% L%;
--secondary-foreground: H S% L%;
--muted: H S% L%;
--muted-foreground: H S% L%;
--accent: H S% L%;
--accent-foreground: H S% L%;
--destructive: H S% L%;
--destructive-foreground: H S% L%;
--border: H S% L%;
--input: H S% L%;
--radius: Xrem;
```

**Dark mode (`.dark`):** Same variables with dark mode values.

#### 2.3 Typography (`app/layout.tsx`)

Replace the font import:
```typescript
import { DS_Font_Name } from 'next/font/google';

const displayFont = DS_Font_Name({
  subsets: ['latin'],
  display: 'swap',
  variable: '--font-space-display',
  weight: ['300', '400', '500', '600', '700'], // DS weights
});

const baseFont = DS_Font_Name({
  subsets: ['latin'],
  display: 'swap',
  variable: '--font-space-default',
  weight: ['300', '400', '500', '600', '700'],
});
```

#### 2.4 Tailwind Extensions (`tailwind.config.js`)

Extend theme with DS values:

```javascript
// In theme.extend:
borderRadius: {
  none: '0px',
  sm: 'DS_SM',
  DEFAULT: 'DS_DEFAULT',
  md: 'DS_MD',
  lg: 'DS_LG',
  xl: 'DS_XL',
  full: '9999px',
},
boxShadow: {
  sm: 'DS_SHADOW_SM',
  DEFAULT: 'DS_SHADOW_DEFAULT',
  md: 'DS_SHADOW_MD',
  lg: 'DS_SHADOW_LG',
  xl: 'DS_SHADOW_XL',
},
```

### Phase 3: Visual Audit & Component Adjustments

**After updating configs, run `npm run dev` and visually audit.**

Most components will already look correct because they use token classes (`bg-primary-300`, `bg-background`, etc.) that now resolve to DS values.

**Components that may need manual class adjustments:**

Only edit components where:
1. The specific shade number (e.g., `primary-300` vs `primary-500`) doesn't match the DS intent
2. Opacity values (e.g., `/70`, `/90`) don't match the DS style
3. Spacing or radius classes need specific DS values
4. The DS has different interaction states (hover, focus, disabled)

**PRINCIPLE when editing components:**
- CHANGE: Tailwind CSS classes only (colors, spacing, typography, radius, shadows)
- PRESERVE: imports, types, interfaces, props, logic, hooks, event handlers, accessibility attributes
- PRESERVE: variant names (default, secondary, outline, ghost, destructive)
- PRESERVE: CVA structure and compound variants logic

**Example (CORRECT transformation):**
```tsx
// BEFORE:
"bg-primary-300/70 text-primary-foreground hover:bg-primary-300/90"

// AFTER (using DS tokens, NOT hardcoded values):
"bg-primary-500 text-primary-foreground hover:bg-primary-600"
// Note: text-primary-foreground stays because it reads from CSS variable
```

**Components most likely to need manual adjustment:**
- Button (shade selections, hover states)
- Badge (specific color variants)
- CTA Button (gradient or specific colors)
- Alert (semantic color mappings)
- Any component using hardcoded opacity or specific shade numbers

### Phase 4: Create Missing Components

If the DS defines components NOT in the repo:

1. Create in `components/shared/ui/`
2. Use Radix UI primitives as base
3. Apply DS tokens via Tailwind classes
4. Follow existing patterns (cva, cn, forwardRef)
5. Only create components that are actually NEEDED

### Phase 5: Agent Rules

Create `.cursor/rules/design-system-brand.mdc`:

```markdown
---
description: [DS NAME] Design System identity - APPLY when generating UI
globs:
alwaysApply: true
---

# Design System: [NAME]

## Source of Truth
- Numeric palette: data/config/colors.js
- Semantic variables: css/globals.css
- Tailwind extensions: tailwind.config.js
- Components: components/shared/ui/

## Color Usage Rules
- Use `bg-primary-500` for primary actions (from numeric palette)
- Use `bg-background`, `text-foreground` for surfaces (from CSS variables)
- Use `bg-destructive` for errors (from CSS variables)
- NEVER use hardcoded hex values
- ALWAYS include dark: variants

## Typography
- Font: [DS FONT NAME]
- Headings: font-display class
- Body: font-sans class

## Border Radius
- Buttons: rounded-[DS_VALUE]
- Cards: rounded-[DS_VALUE]
- Inputs: rounded-[DS_VALUE]

## Key Tokens
[List the actual DS values here for quick reference]
```

### Phase 6: Verification (CRITICAL)

#### 6.1 TypeScript Check
```bash
npx tsc --noEmit
```
Fix ALL errors before proceeding.

#### 6.2 Dev Server
```bash
npm run dev
```
Open in browser and check BOTH light and dark mode.

#### 6.3 Visual Checklist
- [ ] Primary color matches DS
- [ ] Font family loaded and rendering
- [ ] Border radius matches DS (check buttons, cards, inputs)
- [ ] Shadows match DS elevation levels
- [ ] Background/surface colors match
- [ ] Dark mode looks correct
- [ ] Hover/focus states work properly

#### 6.4 Coherence Test

Ask to create a component WITHOUT specifying any styles:
```
"Create /app/test-coherence/page.tsx with a login form using Card, Input, Button, and a Dialog for password recovery."
```

**Verify the agent automatically uses:**
- [ ] DS colors (not default Shadcn yellow)
- [ ] DS border radius
- [ ] DS typography
- [ ] DS spacing

If any component looks "default" or doesn't match DS, go back and fix it.

## Anti-Patterns

- DO NOT copy-paste DS component source files (different dependency tree)
- DO NOT use CSS-in-JS patterns if repo uses Tailwind
- DO NOT use hardcoded `text-white` or `text-black` — use `text-primary-foreground` or DS text tokens
- DO NOT skip the git branch step
- DO NOT clone entire DS repos (100s of MB) when a config.json manifest suffices
- DO NOT manually edit ALL 55 components — update config files first, then only fix what doesn't match
